<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi Camera Feed</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* General Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }

        header, footer {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: #ffffff;
            margin-bottom: 5px;
        }

        /* Gallery Grid Layout */
        #gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Individual Card Styling */
        .gallery-card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .gallery-card .media-container {
            width: 100%;
            height: 220px; /* Fixed height for media container */
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .gallery-card img, .gallery-card video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures media fills the container */
        }
        
        /* Styles for the video placeholder */
        .video-placeholder {
            padding: 20px;
            text-align: center;
            font-size: 0.9em;
            color: #888;
        }

        .video-placeholder a {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #333;
            color: #eee;
            text-decoration: none;
            border-radius: 4px;
            border: 1px solid #555;
        }
        .video-placeholder a:hover {
            background-color: #444;
        }


        .gallery-card .info-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .gallery-card .ai-description {
            font-style: italic;
            color: #a0a0a0;
            margin-bottom: 15px;
            flex-grow: 1; /* Pushes timestamp to the bottom */
        }

        .gallery-card .ai-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .gallery-card .ai-tag {
            background-color: #3a3a3a;
            color: #d0d0d0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .gallery-card .timestamp {
            font-size: 0.8em;
            color: #777;
            text-align: right;
            margin-top: auto; /* Aligns to the bottom */
        }

        #loading-indicator {
            color: #888;
            text-align: center;
            width: 100%;
            grid-column: 1 / -1; /* Make it span the full width of the grid */
        }
    </style>
</head>
<body>

    <header>
        <h1>Raspberry Pi Camera Feed</h1>
        <p>Live captures from the camera with AI analysis.</p>
    </header>

    <main id="gallery-container">
        <p id="loading-indicator">Loading captures...</p>
    </main>

    <footer>
        <p>A simple viewer for the Supabase-powered Pi Camera script.</p>
    </footer>
    
    <script>
        // --- ðŸ”‘ Configuration ---
        const SUPABASE_URL = "https://afcretnuqilwhzxijssx.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmY3JldG51cWlsd2h6eGlqc3N4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MjMyMDYsImV4cCI6MjA3MDk5OTIwNn0.7GXsrkTQSCbeM7GhYYzD4y9ddjaqAejb_3i9QOaFimk";

        // --- Initialize Supabase Client ---
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- DOM Elements ---
        const galleryContainer = document.getElementById('gallery-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        /**
         * Fetches data from the 'images' table and displays it on the page.
         */
        async function fetchAndDisplayCaptures() {
            try {
                const { data, error } = await supabaseClient
                    .from('images')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (error) { throw error; }

                if (loadingIndicator) { loadingIndicator.style.display = 'none'; }
                
                galleryContainer.innerHTML = ''; 

                if (data.length === 0) {
                    galleryContainer.innerHTML = '<p id="loading-indicator">No captures found. Run your Python script to upload some!</p>';
                    return;
                }

                data.forEach(item => {
                    const card = createCaptureCard(item);
                    galleryContainer.appendChild(card);
                });

            } catch (error) {
                console.error('Error fetching data:', error);
                if(loadingIndicator) { loadingIndicator.innerText = `Failed to load data: ${error.message}`; }
            }
        }

        /**
         * Creates an HTML card element for a single capture item.
         * @param {object} item - A single record from the 'images' table.
         * @returns {HTMLElement} - The card element.
         */
        function createCaptureCard(item) {
            const card = document.createElement('div');
            card.className = 'gallery-card';

            let mediaElement;
            // This logic shows a download button for H264 files
            if (item.file_type === 'video' && item.url.endsWith('.h264')) {
                mediaElement = `
                    <div class="video-placeholder">
                        <p>Raw H.264 Video</p>
                        <span>(Playback not available in browser)</span>
                        <a href="${item.url}" download>Download File</a>
                    </div>
                `;
            } else if (item.file_type === 'video') {
                mediaElement = `<video controls muted loop playsinline src="${item.url}"></video>`;
            } else {
                mediaElement = `<img src="${item.url}" alt="${item.filename}" loading="lazy">`;
            }

            let detectedObjects = [];
            try {
                detectedObjects = JSON.parse(item.detected_objects || '[]');
            } catch (e) { console.warn(`Could not parse detected_objects for ${item.filename}:`, item.detected_objects); }
            
            const tagsHTML = detectedObjects.map(obj => {
                const confidence = (obj.confidence * 100).toFixed(0);
                return `<span class="ai-tag">${obj.label} (${confidence}%)</span>`;
            }).join('');

            const formattedDate = new Date(item.timestamp).toLocaleString();

            card.innerHTML = `
                <div class="media-container">
                    ${mediaElement}
                </div>
                <div class="info-container">
                    <p class="ai-description">${item.ai_description || 'No AI description available.'}</p>
                    ${tagsHTML ? `<div class="ai-tags-container">${tagsHTML}</div>` : ''}
                    <p class="timestamp">${formattedDate}</p>
                </div>
            `;
            return card;
        }

        document.addEventListener('DOMContentLoaded', fetchAndDisplayCaptures);
    </script>
</body>
</html>
